<!-- --- START OF FILE arc_database_v1.5.0.html --- -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARC RAIDERS // DATABASE v1.5.0</title>
    <style>
        /* FONTS */
        @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700&family=Rajdhani:wght@500;600;700&family=Teko:wght@300;400;500;600;700&display=swap');

        :root {
            /* GAME UI PALETTE */
            --bg-body: #050505;
            --bg-overlay: rgba(10, 10, 12, 0.85);
            --bg-panel: rgba(20, 22, 25, 0.7);
            --border-tech: rgba(255, 255, 255, 0.15);
            
            /* COLORS */
            --arc-yellow: #ffc400;
            --arc-white: #e6e6e6;
            --arc-teal: #00e5ff;   
            --arc-red: #ff2a2a;
            
            /* SIDEBAR COLORS */
            --sb-inactive-bg: #2b2f3b;
            --sb-inactive-icon: #7f838d;
            --sb-active-bg: #f2e8d5;
            --sb-active-icon: #141619;

            /* SIDEBAR DIMENSIONS */
            --sb-icon-size: 52px;
            --sb-gap: 8px;

            /* NAVBAR SPACING */
            --nav-gap: 5px;          
            --nav-padding-x: 10px;   

            /* CARD COLORS */
            --card-bg: #f2e8d5;
            --card-footer: #dcd0b9;
            --card-text: #121418;
            
            /* RARITY COLORS */
            --col-common: #7a7a7a;
            --col-uncommon: #009e48;
            --col-rare: #0090d4;
            --col-epic: #a040b0;
            --col-legendary: #ff9600;
            --col-material: #0090d4;
            --col-recycle: #009e48;

            /* FONTS */
            --font-head: 'Teko', sans-serif;
            --font-ui: 'Rajdhani', sans-serif;
            --font-body: 'Barlow', sans-serif;

            /* DYNAMIC SIZES */
            --header-h: 80px;
            --logo-h: 30px;
            --nav-font: 1.5rem;
            --btn-play-h: 40px;
            --btn-play-font: 1.4rem;
            --btn-sys-h: 34px;
            --search-w: 200px;
            --sb-w: 70px;
            --content-pad-left: 130px;
        }

        /* --- RESPONSIVE LOGIC --- */
        
        @media (max-width: 1600px) {
            :root {
                --header-h: 65px;
                --logo-h: 24px;
                --nav-font: 1.2rem;
                --nav-gap: 4px;
                --nav-padding-x: 8px;
                --btn-play-h: 34px;
                --btn-play-font: 1.1rem;
                --btn-sys-h: 30px;
                --search-w: 160px;
                --sb-icon-size: 46px;
                --sb-gap: 6px;
                --sb-w: 60px;
                --content-pad-left: 110px;
            }
        }

        @media (max-width: 1300px) {
            :root {
                --header-h: 55px;
                --nav-font: 1.0rem;
                --nav-gap: 2px;
                --nav-padding-x: 5px;
                --btn-play-h: 30px;
                --btn-play-font: 1rem;
                --btn-sys-h: 26px;
                --search-w: 130px;
                --sb-icon-size: 40px;
                --sb-gap: 4px;
                --sb-w: 50px;
                --content-pad-left: 90px;
            }
            .header-left, .header-right { gap: 10px !important; }
            .version-badge { display: none; }
        }

        @media (max-height: 900px) {
            :root {
                --sb-icon-size: 40px;
                --sb-gap: 4px;
            }
        }

        /* GLOBAL RESET */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

        body {
            background-color: var(--bg-body);
            background: radial-gradient(circle at 50% 30%, #1a1f2e 0%, #050505 80%);
            background-attachment: fixed;
            color: var(--arc-white);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        /* --- UI LAYOUT --- */
        .layout-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: var(--header-h);
        }

        /* --- HEADER --- */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 100%);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            transition: height 0.3s ease;
        }

        .header-left { display: flex; align-items: center; gap: 20px; height: 100%; }

        .logo-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 5px; }
        .app-logo { height: var(--logo-h); display: flex; justify-content: center; align-items: center; }
        .app-logo img { height: 100%; width: auto; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255, 196, 0, 0.3)); }
        .version-badge { font-family: var(--font-ui); font-size: 0.6rem; color: #555; font-weight: 700; letter-spacing: 1px; margin-top: 2px; }

        /* PLAY BUTTON */
        .connect-wrapper { position: relative; height: var(--btn-play-h); display: flex; align-items: center; }
        
        .btn-play {
            background-color: var(--arc-yellow); color: #050505;
            height: var(--btn-play-h); padding: 0 15px; border-radius: 40px;
            font-family: var(--font-head); font-weight: 700; font-size: var(--btn-play-font); letter-spacing: 1px;
            border: none; cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; z-index: 2; overflow: hidden; min-width: auto;
        }
        .btn-play::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 30px; background: rgba(0,0,0,0.1); transform: skewX(-15deg) translateX(15px); }
        .btn-play svg { width: 18px; height: 18px; fill: #000; transition: transform 0.2s; }

        .connect-dropdown {
            position: absolute; top: 50%; left: 25px; height: var(--btn-play-h);
            background: #111; border: 1px solid var(--arc-yellow); border-radius: 0 40px 40px 0;
            padding-left: 140px; padding-right: 30px;
            display: flex; align-items: center; gap: 5px;
            opacity: 0; pointer-events: none;
            transform: translateY(-50%) translateX(-20px); transition: all 0.3s ease; z-index: 1;
        }
        .connect-wrapper:hover .btn-play { transform: translateX(-5px); }
        .connect-wrapper:hover .connect-dropdown { opacity: 1; pointer-events: auto; transform: translateY(-50%) translateX(0); }

        .sub-btn {
            background: transparent; color: var(--arc-yellow); border: 1px solid rgba(255, 196, 0, 0.3);
            font-family: var(--font-ui); font-weight: 700; font-size: 0.8rem; padding: 0 8px; height: 70%;
            border-radius: 4px; cursor: pointer; text-transform: uppercase; white-space: nowrap;
        }
        .sub-btn:hover { background: var(--arc-yellow); color: #000; }

        /* NAV LINKS */
        .nav-links { 
            display: flex; 
            gap: var(--nav-gap);
            margin-left: 10px; 
            opacity: 0.3; pointer-events: none; transition: 0.3s; align-items: center; 
        }
        body.db-loaded .nav-links { opacity: 1; pointer-events: auto; }

        .nav-item {
            font-family: var(--font-head); font-weight: 600; font-size: var(--nav-font); color: #999;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; position: relative;
            padding: 2px var(--nav-padding-x); 
            border: 2px solid transparent; border-radius: 50px;
            white-space: nowrap;
        }
        .nav-item:hover { color: #fff; }
        .nav-item.active { color: #fff; border-color: #f0ebd8; background: rgba(255,255,255,0.05); box-shadow: 0 0 15px rgba(240, 235, 216, 0.1); }

        /* HEADER RIGHT */
        .header-right { display: flex; align-items: center; gap: 10px; }

        .search-container { position: relative; }
        .search-box {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 0 25px 0 12px; color: #fff; width: var(--search-w); height: var(--btn-sys-h); border-radius: 4px;
            font-family: var(--font-ui); text-transform: uppercase; outline: none; transition: 0.3s; font-size: 0.9rem;
        }
        .search-box:focus { border-color: var(--arc-teal); background: rgba(0, 229, 255, 0.05); }
        .search-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; font-size: 0.8rem; }
        
        .btn-system {
            height: var(--btn-sys-h); padding: 0 12px; background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: #ccc; font-family: var(--font-ui); font-weight: 600; text-transform: uppercase; border-radius: 20px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s;
            font-size: 0.9rem; white-space: nowrap;
        }
        .btn-system:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.05); }
        .btn-system.active { background: var(--arc-yellow); color: #000; border-color: var(--arc-yellow); font-weight: 700; }
        .btn-system.bp-filter-owned { background: var(--arc-teal); color: #000; border-color: var(--arc-teal); }
        .btn-system.bp-filter-missing { background: var(--arc-red); color: #000; border-color: var(--arc-red); }
        .img-toggle-btn.mode-remote { border-color: var(--arc-teal); color: var(--arc-teal); background: rgba(0, 229, 255, 0.1); }
        .btn-icon { width: var(--btn-sys-h); height: var(--btn-sys-h); padding: 0; border-radius: 50%; }

        /* FIX DROPDOWN COLOR */
        select option { background-color: #111; color: #fff; }
        #langSelect { background-color: rgba(255,255,255,0.05); color: #fff; }

        /* --- SIDEBAR --- */
        aside {
            position: absolute; 
            top: calc(var(--header-h) + 20px); 
            left: 30px; bottom: 20px; 
            width: var(--sb-w);
            background: transparent; border: none;
            display: none; 
            flex-direction: column; align-items: center; 
            padding: 10px 0; 
            gap: var(--sb-gap);
            z-index: 90;
            overflow-y: auto; overflow-x: hidden; 
            animation: slideInLeft 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        aside::-webkit-scrollbar { width: 0; }
        body.db-loaded aside { display: flex; }
        body.section-progetti aside { display: none !important; width: 0 !important; pointer-events: none; }

        @keyframes slideInLeft { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .filter-circle {
            width: var(--sb-icon-size); height: var(--sb-icon-size);
            border-radius: 50%;
            background-color: var(--sb-inactive-bg);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s; flex-shrink: 0; 
            border: 2px solid transparent; 
            position: relative;
        }
        .filter-circle:hover { transform: scale(1.05); border-color: #555; }
        .filter-circle.active { background-color: var(--sb-active-bg); border-color: var(--sb-active-bg); box-shadow: 0 0 15px rgba(242, 232, 213, 0.2); }
        
        .filter-circle svg { width: 55%; height: 55%; fill: var(--sb-inactive-icon); transition: fill 0.2s; }
        .filter-circle:hover svg { fill: #fff; }
        .filter-circle.active svg { fill: var(--sb-active-icon); }
        
        .filter-circle img { width: 100%; height: 100%; pointer-events: none; border-radius: 50%; }
        
        .filter-circle .icon-active { display: none; }
        .filter-circle .icon-inactive { display: block; }
        .filter-circle.active .icon-active { display: block; }
        .filter-circle.active .icon-inactive { display: none; }
        
        .filter-circle.has-image { background-color: transparent; border: none; }
        .filter-circle.has-image:hover { transform: scale(1.05); }
        
        .sidebar-sep { width: 30px; height: 1px; background: rgba(255,255,255,0.1); margin: 2px 0; flex-shrink: 0; }

        /* --- CONTENT AREA --- */
        .content-area {
            flex: 1;
            padding: 20px 40px 40px 40px; 
            overflow-y: auto;
            transition: padding-left 0.3s ease;
        }
        body.db-loaded .content-area { padding-left: var(--content-pad-left); }
        body.section-progetti .content-area { padding-left: 40px !important; }
        
        .section-header-bp { margin-bottom: 20px; animation: fadeIn 0.5s ease; }
        .sh-title { font-family: var(--font-head); font-size: 2.5rem; color: #fff; line-height: 1; letter-spacing: 2px; text-transform: uppercase; }
        .sh-subtitle { font-family: var(--font-head); font-size: 1.1rem; color: #bbb; letter-spacing: 1px; margin-top: 5px; font-weight: 600; text-transform: uppercase;}
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stash-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding-bottom: 100px; 
            position: relative; z-index: 5;
        }

        .slot {
            aspect-ratio: 1; background-color: rgba(15, 15, 15, 0.6);
            border: 1px solid var(--border-tech); border-radius: 2px;
            position: relative; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; overflow: hidden;
        }
        .slot:hover { border-color: #fff; background-color: rgba(40, 40, 45, 0.8); box-shadow: 0 0 15px rgba(255,255,255,0.1); transform: scale(1.02); z-index: 2; cursor: pointer;}
        .slot img { max-width: 80%; max-height: 80%; object-fit: contain; pointer-events: none; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8)); }
        .slot-fallback { width: 30px; height: 30px; fill: #444; pointer-events: none; }
        .slot .fallback-text { position:absolute; bottom:5px; font-size:0.65rem; color:#888; text-align:center; width:90%; pointer-events: none; font-weight: 600; text-transform: uppercase;}
        .slot::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; opacity:0.8; pointer-events:none; }
        .slot.common::after { background: var(--col-common); opacity: 0.3; }
        .slot.uncommon::after { background: var(--col-uncommon); box-shadow: 0 -2px 5px rgba(46, 125, 50, 0.5); }
        .slot.rare::after { background: var(--col-rare); box-shadow: 0 -2px 5px rgba(0, 144, 212, 0.5); }
        .slot.epic::after { background: var(--col-epic); box-shadow: 0 -2px 5px rgba(156, 39, 176, 0.5); }
        .slot.legendary::after { background: var(--col-legendary); box-shadow: 0 -2px 5px rgba(255, 196, 0, 0.5); }
        
        .bp-badge { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10; font-weight: 900; font-family: var(--font-head); font-size: 2rem; pointer-events: none; background: rgba(0,0,0,0.7); }
        .bp-owned { color: var(--arc-teal); border: 2px solid var(--arc-teal); background: rgba(0, 229, 255, 0.1); }
        .bp-missing { color: var(--arc-red); border: 2px solid var(--arc-red); background: rgba(255, 42, 42, 0.1); }
        .slot.owned { border-color: var(--arc-teal); box-shadow: inset 0 0 20px rgba(0, 229, 255, 0.2); }
        .slot.is-missing img { opacity: 0.2; filter: grayscale(100%); }

        .slot-controls { position: absolute; bottom: 3px; left: 0; right: 0; height: 24px; display: none; flex-direction: row; background: rgba(0,0,0,0.9); z-index: 20; }
        .slot:hover .slot-controls { display: flex; }
        .wl-btn { flex: 1; background: transparent; color: #aaa; border: none; text-align: center; cursor: pointer; font-size: 1.2rem; line-height: 24px; font-weight: 700; }
        .wl-btn:hover { color: #fff; background: rgba(255,255,255,0.2); }
        .wishlist-badge { position: absolute; top: 4px; right: 4px; background: var(--arc-yellow); color: #000; font-weight: 800; font-size: 0.8rem; padding: 2px 6px; border-radius: 2px; z-index: 20; pointer-events: none; box-shadow: 0 0 5px var(--arc-yellow); }

        /* --- TOOLTIP (HOVER - BEIGE CARD) --- */
        #tooltip { 
            position: fixed; display: none; width: 340px; 
            background-color: var(--card-bg); color: var(--card-text); 
            box-shadow: 0 40px 80px rgba(0,0,0,1); 
            z-index: 11000; font-family: var(--font-body); pointer-events: none; 
            border-radius: 4px; overflow: hidden; border: none; 
        }
        #tooltip.interactive { pointer-events: auto !important; }

        /* --- SIDEBAR TOOLTIP (CUSTOM) --- */
        #sidebar-tooltip {
            position: fixed; display: none; 
            background: rgba(10, 10, 10, 0.95); 
            color: var(--arc-yellow);
            border: 1px solid var(--arc-yellow);
            padding: 5px 12px; 
            font-family: var(--font-ui); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            font-size: 0.9rem;
            z-index: 12000; pointer-events: none;
            border-radius: 0 8px 8px 8px;
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .tt-header { display: flex; height: 26px; background: transparent; }
        .tt-tag { padding: 0 10px; font-family: var(--font-head); font-weight: 600; font-size: 1.1rem; color: white; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 5px; height: 100%; }
        .tt-tag svg { width: 14px; height: 14px; fill: white; }
        .tt-body { padding: 16px 20px; }
        .tt-title { font-family: var(--font-head); font-weight: 700; font-size: 2.2rem; line-height: 0.9; margin-bottom: 12px; text-transform: uppercase; color: #000; letter-spacing: 0.5px; }
        .tt-desc { font-size: 0.95rem; line-height: 1.35; color: #222; margin-bottom: 20px; font-weight: 500; font-family: var(--font-body); }
        
        .tt-found { border-top: 1px solid #c0b49b; padding-top: 10px; margin-top: 10px; }
        .tt-found-label { font-size: 0.8rem; font-weight: 700; color: #555; text-transform: uppercase; margin-bottom: 4px; font-family: var(--font-head); letter-spacing: 1px; }
        .tt-found-val { display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 0.95rem; text-transform: uppercase; color: #000; }
        .tt-found-val svg { width: 16px; height: 16px; fill: #000; }

        .tt-footer { background: var(--card-footer); display: flex; height: 50px; border-top: 1px solid #c9bea6; }
        .tt-foot-item { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: var(--font-head); font-weight: 600; font-size: 1.3rem; border-right: 1px solid #c9bea6; color: #1a1a1a; }
        .tt-foot-item:last-child { border-right: none; }
        .tt-foot-item svg { fill: #1a1a1a; display: block; }
        .tt-foot-item img { display: block; filter: none; opacity: 1; }

        /* --- POPUP / INFO MODAL (DARK TECHNICAL DETAILS) --- */
        #modalBackdrop {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
            z-index: 11500; display: none;
        }

        .overlay-container { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #111; /* Dark Background */
            color: var(--arc-white); 
            box-shadow: 0 0 100px rgba(0,0,0,1); 
            z-index: 12000; 
            width: 450px;
            /* FIXED: Scroll functionality */
            display: none;
            flex-direction: column;
            max-height: 85vh; /* Max height relative to viewport */
            border-radius: 4px; 
            border: 1px solid var(--arc-yellow); 
            user-select: text !important; 
            cursor: auto;
        }
        .overlay-container * { user-select: text !important; cursor: auto; }
        
        .overlay-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; border-bottom: 1px solid #333; 
            background: #1a1a1a;
            user-select: none !important;
            flex-shrink: 0; /* Header never shrinks */
        }
        
        .overlay-title { font-family: var(--font-head); font-size: 2.2rem; color: var(--arc-yellow); margin: 0; text-transform: uppercase; line-height: 1; }
        .overlay-close { background: none; border: none; color: #666; font-size: 2.5rem; cursor: pointer; line-height: 1; user-select: none !important; transition:0.2s;}
        .overlay-close:hover { color: #fff; }

        /* Scrollable content area */
        .overlay-scrollable-content {
            overflow-y: auto; 
            flex: 1; /* Occupies remaining space */
            background: #111; 
            color: #fff; 
            padding: 15px;
        }
        /* Custom scrollbar for popup */
        .overlay-scrollable-content::-webkit-scrollbar { width: 8px; }
        .overlay-scrollable-content::-webkit-scrollbar-track { background: #1a1a1a; }
        .overlay-scrollable-content::-webkit-scrollbar-thumb { background: var(--arc-yellow); border-radius: 4px; }

        .info-section { background: #161616; border: 1px solid #2c2c2c; margin-bottom: 20px; padding: 15px; border-radius: 2px;}
        .info-title { color: var(--arc-white); font-family: var(--font-head); font-size: 1.4rem; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; letter-spacing: 1px;}
        
        .info-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .info-table th { text-align: left; color: #888; border-bottom: 1px solid #333; padding: 5px; font-weight: 600; font-family: var(--font-ui); text-transform: uppercase; font-size: 0.8rem;}
        .info-table td { padding: 8px 5px; border-bottom: 1px solid #222; color: #ccc; vertical-align: middle; }
        .info-table tr:last-child td { border-bottom: none; }
        
        .info-table img, .mini-icon { width: 32px; height: 32px; object-fit: contain; vertical-align: middle; margin-right: 10px; border-radius: 2px; background: rgba(255,255,255,0.05); }

        .recipe-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #222; font-family: var(--font-ui); font-size: 1rem; align-items: center; }
        .recipe-row:last-child { border-bottom: none; }
        .recipe-hl { color: var(--arc-yellow); font-weight: 700; }

        .val-total { font-weight: 700; font-size: 1.1rem; }
        .val-better { color: var(--arc-teal); } 
        .val-worse { color: var(--arc-red); } 

        #adminModal { width: 600px; }
        .edit-form { display: flex; flex-direction: column; gap: 10px; color: #ddd; padding: 20px; }
        .edit-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .edit-input { background: #000; border: 1px solid #444; color: white; padding: 8px; width: 65%; font-family: var(--font-ui); font-size: 1rem; }

        #loader { background: #000; }
        .spinner { border-color: #333; border-top-color: var(--arc-yellow); }
        
        input[type="file"] { display: none; }
    
  /* Loader overlay adjustments */
  #loader{position:fixed; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; background:rgba(0,0,0,0.6); z-index:20000;}
  #loader h2{display:none; margin-top:10px;}
  .spinner{display:none;}
  .loader-custom{ width: 108px; height: 108px; display:block; animation: arcspin 2.2s linear infinite; }
  @keyframes arcspin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

  /* --- AGGIUNTE PER OFFICINA E POPUP (NON TOCCANO IL LAYOUT GRID) --- */
  details.upgrade-level { margin-bottom: 10px; background: #111; border-left: 3px solid var(--arc-teal); transition: 0.2s; }
  details.upgrade-level[open] { background: #1a1a1a; }
  details.upgrade-level summary {
      padding: 10px; color: #fff; font-weight: bold; cursor: pointer; text-transform: uppercase; list-style: none; display: flex; justify-content: space-between; align-items: center;
  }
  details.upgrade-level summary::-webkit-details-marker { display: none; }
  details.upgrade-level summary:hover { color: var(--arc-yellow); }
  .btn-track { background: transparent; border: 1px solid #444; color: #888; padding: 2px 8px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; text-transform: uppercase; font-family: var(--font-ui); font-weight: 700; transition: 0.2s; display: flex; align-items: center;}
  .btn-track:hover { border-color: var(--arc-yellow); color: var(--arc-yellow); }
  .btn-track.added { background: var(--arc-yellow); color: #000; border-color: var(--arc-yellow); }

</style>
</head>
<body>

<div id="loader">
  <!-- NUOVO SVG DI CARICAMENTO -->
  <svg class="loader-custom" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="50" fill="black" />
    <circle cx="50" cy="50" r="48.5" stroke="white" stroke-width="3" fill="none" />
    <g stroke="white" stroke-width="3" fill="black" stroke-linejoin="round" stroke-linecap="round">
      <circle cx="50" cy="50" r="11" />
      <defs>
        <path id="reel-blade" d="M 45 29 L 39 9 A 42 42 0 0 1 61 9 L 55 29 A 25 25 0 0 1 45 29 Z" />
      </defs>
      <use href="#reel-blade" />
      <use href="#reel-blade" transform="rotate(120, 50, 50)" />
      <use href="#reel-blade" transform="rotate(240, 50, 50)" />
    </g>
  </svg>
    <div class="spinner"></div>
    <h2 style="margin-top:25px; font-family:var(--font-head); letter-spacing:2px; font-size: 1.5rem; color:#fff">LOADING</h2>
    <div id="loader-text" style="color:#666; font-family:var(--font-ui); margin-top:5px;"></div>
</div>

<div id="modalBackdrop" onclick="closeInfoModal()"></div>

<!-- CUSTOM SIDEBAR TOOLTIP -->
<div id="sidebar-tooltip"></div>

<!-- SIDEBAR -->
<aside id="sidebarPanel"></aside>

<div class="layout-container">
    <header>
        <div class="header-left">
            <div class="logo-wrapper">
                <div class="app-logo">
                    <img src="images/menu/ARC Raiders.png" alt="ARC Raiders">
                </div>
                <span class="version-badge">v1.5.0</span>
            </div>

            <div class="connect-wrapper">
                <button class="btn-play">
                    DATABASE
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <div class="connect-dropdown">
        <button class="sub-btn" id="pickRaidTheory" onclick="pickRepo('Speranza', event)">Speranza</button>
        <button class="sub-btn" id="pickLocal" onclick="pickRepo('Local', event)">Locale</button>
        <select id="repoSelect" class="sub-btn" style="display:none">
          <option value="Speranza">Speranza</option>
          <option value="Local">Locale</option>
        </select>
</div>
            </div>
            
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">

            <!-- NAV LINKS: SWITCH MAIN SECTION -->
            <div class="nav-links">
                <div class="nav-item active" onclick="setSection('INVENTARIO')" data-nav="INVENTARIO">INVENTARIO</div>
                <div class="nav-item" onclick="setSection('OFFICINA')" data-nav="OFFICINA">OFFICINA</div>
                <div class="nav-item" onclick="setSection('PROGETTI')" data-nav="PROGETTI">PROGETTI</div>
                <div class="nav-item" onclick="setSection('MERCANTI')" data-nav="MERCANTI">MERCANTI</div>
                <div class="nav-item" onclick="setSection('NEGOZIO')" data-nav="NEGOZIO">NEGOZIO</div>
                <div class="nav-item" onclick="setSection('MISSIONI')" data-nav="MISSIONI">MISSIONI</div>
            </div>
        </div>

        <div class="header-right">
             <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="SEARCH" disabled>
                <span class="search-clear" id="searchClear" onclick="clearSearch()">âœ•</span>
            </div>

             <button class="btn-system" id="btnWishlist" onclick="handleTopRightButton()">
                <svg id="iconWishlist" width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm0 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                <span id="btnWishlistText">WISHLIST</span> <span id="wlCounter" class="wl-counter" style="display:none">0</span>
            </button>

            <select id="langSelect" class="btn-system" style="width: auto;">
                <option value="it">ITA</option>
                <option value="en">ENG</option>
                <option value="da">DAN</option>
                <option value="de">DEU</option>
                <option value="es">ESP</option>
                <option value="fr">FRA</option>
                <option value="he">HEB</option>
                <option value="hr">HRV</option>
                <option value="ja">JPN</option>
                <option value="ko">KOR</option>
                <option value="no">NOR</option>
                <option value="pl">POL</option>
                <option value="pt">POR</option>
                <option value="pt-BR">BRA</option>
                <option value="ru">RUS</option>
                <option value="tr">TUR</option>
                <option value="uk">UKR</option>
                <option value="zh-CN">CHN</option>
                <option value="zh-TW">TWN</option>
            </select>
            
            <button id="imgModeBtn" class="btn-system img-toggle-btn" onclick="toggleImageMode()">IMG: LOCAL</button>
            
            <button class="btn-system btn-icon" onclick="exportUserData()" title="BACKUP DATA">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <label for="importInput" class="btn-system btn-icon" title="RESTORE DATA" style="cursor:pointer">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
            </label>
            <input type="file" id="importInput" style="display:none" onchange="importUserData(event)">
            
            <button class="btn-system btn-icon" id="btnAdmin" onclick="toggleAdminMode()" title="Admin Mode">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 0.9-2 2v10c0 1.1 0.9 2 2 2h12c1.1 0 2-0.9 2-2V10c0-1.1-0.9-2-2-2zm-6 9c-1.1 0-2-0.9-2-2s0.9-2 2-2 2 0.9 2 2-0.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            </button>
            <button class="btn-system" id="btnExport" onclick="exportOverrides()" style="display:none; color:var(--arc-yellow)">SAVE</button>
        </div>
    </header>

    <div class="content-area">
        <div id="grid-container" class="stash-grid">
            <div style="grid-column: 1/-1; text-align: center; margin-top: 20vh; color: #666;">
                <h3 style="font-family: var(--font-head); font-size: 5rem; color: #333; opacity: 0.5;">NO SIGNAL</h3>
                <p style="font-size: 1.2rem; margin-top: 10px; color: var(--arc-yellow);">INITIALIZE DATABASE CONNECTION</p>
                <div style="margin-top: 20px; font-size: 0.9rem; opacity: 0.7;">CLICK 'DATABASE' TO CONNECT</div>
            </div>
        </div>
    </div>
</div>

<!-- OVERLAYS -->
<div id="tooltip"></div>
<div id="infoModal" class="overlay-container"></div>
<div id="adminModal" class="overlay-container"></div>
<svg style="display:none">
    <symbol id="icon-wrench" viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></symbol>
   <symbol id="icon-arc" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2-1-2-1-2 1 2 1zm0 2l-10 5 10 5 10-5-10-5z"/></symbol>
   <symbol id="icon-all" viewBox="0 0 24 24"><path d="M4 4h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4z M4 10h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4z M4 16h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4z"/></symbol>
   <symbol id="icon-cosmetic" viewBox="0 0 24 24"><path d="M12 2C9 2 7 3.5 7 5v2H5v14h14V7h-2V5c0-1.5-2-3-5-3zm0 2c1.5 0 3 1 3 3v2H9V5c0-2 1.5-3 3-3z"/></symbol>
   <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
</svg>

<script>
    let itemsDB = [], hideoutDB = [], allImages = new Map(), overridesDB = {};
    let wishlist = new Map();
    let ownedBlueprints = new Set();
    let currentFilter = 'ALL', viewMode = 'STASH', currentLang = 'it', adminMode = false;
    let isEditing = false, isWishlistView = false, imageMode = 'LOCAL'; 
    let currentSection = 'INVENTARIO';
    let bpViewMode = 0; 
    let isModalOpen = false; 

    const GITHUB_RAW_BASE_URL = 'https://raw.githubusercontent.com/atarufox/Speranza-Archive/main/';

    // --- COMPLETE TRANSLATION DICTIONARY ---
    const TRANSLATIONS = {
        it: {
            ui: { crafting: "RICETTA", bench: "BANCO", ingredient: "INGREDIENTE", qty: "QTA", recycle: "RICICLA IN", item: "OGGETTO", val_u: "VAL/U", tot: "TOT", tot_recycle: "TOTALE RICICLO", sell_val: "VALORE VENDITA", no_recycle: "NON RICICLABILE", used_for: "USATO PER", no_usage: "NESSUN UTILIZZO TROVATO", my_blueprints: "I MIEI PROGETTI", what_i_need: "COSA MI SERVE", have: "CE L'HO", missing: "MANCA", upgrades: "POTENZIAMENTI", level: "LIVELLO", track: "SEGUI", added: "AGGIUNTO", obtained_recycling: "SI OTTIENE RICICLANDO", all: "TUTTI", search: "CERCA" },
            nav: { INVENTARIO: "INVENTARIO", OFFICINA: "OFFICINA", PROGETTI: "PROGETTI", MERCANTI: "MERCANTI", NEGOZIO: "NEGOZIO", MISSIONI: "MISSIONI" },
            filters: { ALL: "TUTTO", POTENZIAMENTI: "POTENZIAMENTI", SCUDI: "SCUDI", ARMI: "ARMI", MUNIZIONI: "MUNIZIONI", MOD: "MOD", USO_RAPIDO: "USO RAPIDO", CHIAVI: "CHIAVI", MATERIALI: "MATERIALI", VARIE: "VARIE", COSMETICS: "COSMETICS" },
            types: { "Material": "MATERIALE", "Weapon": "ARMA", "Ammunition": "MUNIZIONI", "Consumable": "CONSUMABILE", "Quick Use": "USO RAPIDO", "Medical": "MEDICO", "Grenade": "GRANATA", "Gadget": "GADGET", "Augment": "POTENZIAMENTO", "Shield": "SCUDO", "Armor": "ARMATURA", "Currency": "VALUTA", "Key": "CHIAVE", "Recyclable": "RICICLABILE", "Refined Material": "MATERIALE RAFFINATO", "Topside Material": "MATERIALE SUPERFICIE", "Basic Material": "MATERIALE BASE", "Upgrade Station": "STAZIONE POTENZIAMENTO" }
        },
        en: {
            ui: { crafting: "CRAFTING RECIPE", bench: "BENCH", ingredient: "INGREDIENT", qty: "QTY", recycle: "RECYCLES INTO", item: "ITEM", val_u: "VAL/U", tot: "TOT", tot_recycle: "TOTAL SCRAP VALUE", sell_val: "SELL VALUE", no_recycle: "NOT RECYCLABLE", used_for: "USED FOR", no_usage: "NO USAGE FOUND", my_blueprints: "MY BLUEPRINTS", what_i_need: "WHAT I NEED", have: "OWNED", missing: "MISSING", upgrades: "UPGRADES", level: "LEVEL", track: "TRACK", added: "ADDED", obtained_recycling: "OBTAINED BY RECYCLING", all: "ALL", search: "SEARCH" },
            nav: { INVENTARIO: "INVENTORY", OFFICINA: "HIDEOUT", PROGETTI: "BLUEPRINTS", MERCANTI: "TRADERS", NEGOZIO: "STORE", MISSIONI: "QUESTS" },
            filters: { ALL: "ALL", POTENZIAMENTI: "AUGMENTS", SCUDI: "SHIELDS", ARMI: "WEAPONS", MUNIZIONI: "AMMO", MOD: "MODS", USO_RAPIDO: "QUICK USE", CHIAVI: "KEYS", MATERIALI: "MATERIALS", VARIE: "MISC", COSMETICS: "COSMETICS" },
            types: { "Material": "MATERIAL", "Weapon": "WEAPON", "Ammunition": "AMMUNITION", "Consumable": "CONSUMABLE", "Quick Use": "QUICK USE", "Medical": "MEDICAL", "Grenade": "GRENADE", "Gadget": "GADGET", "Augment": "AUGMENT", "Shield": "SHIELD", "Armor": "ARMOR", "Currency": "CURRENCY", "Key": "KEY", "Recyclable": "RECYCLABLE", "Refined Material": "REFINED MATERIAL", "Topside Material": "TOPSIDE MATERIAL", "Basic Material": "BASIC MATERIAL", "Upgrade Station": "UPGRADE STATION" }
        },
        // Altre lingue...
    };

    function getUI(key) {
        if (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang].ui && TRANSLATIONS[currentLang].ui[key]) return TRANSLATIONS[currentLang].ui[key];
        if (TRANSLATIONS['en'].ui[key]) return TRANSLATIONS['en'].ui[key];
        return key; 
    }
    
    function getNav(key) {
        if (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang].nav && TRANSLATIONS[currentLang].nav[key]) return TRANSLATIONS[currentLang].nav[key];
        return TRANSLATIONS['en'].nav[key] || key;
    }
    
    function getFilter(key) {
        if (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang].filters && TRANSLATIONS[currentLang].filters[key]) return TRANSLATIONS[currentLang].filters[key];
        return TRANSLATIONS['en'].filters[key] || key;
    }

    function translateType(rawType) {
        if(!rawType) return "";
        if(rawType.toLowerCase() === 'item') return "ITEM";
        if (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang].types && TRANSLATIONS[currentLang].types[rawType]) return TRANSLATIONS[currentLang].types[rawType];
        if (TRANSLATIONS['en'].types[rawType]) return TRANSLATIONS['en'].types[rawType];
        return rawType.toUpperCase();
    }

    // --- CONFIGURAZIONE FILTRI SIDEBAR ---
    const SIDEBAR_CONFIG = {
        'INVENTARIO': [
            { id: 'ALL', img: 'tutto', type: 'img', labelKey: 'ALL' }, 
            { id: 'POTENZIAMENTI', img: 'potenziamenti', type: 'img', labelKey: 'POTENZIAMENTI' },
            { id: 'SCUDI', img: 'scudi', type: 'img', labelKey: 'SCUDI' },
            { id: 'ARMI', img: 'armi', type: 'img', labelKey: 'ARMI' },
            { id: 'MUNIZIONI', img: 'munizioni', type: 'img', labelKey: 'MUNIZIONI' },
            { id: 'MOD', img: 'mod', type: 'img', labelKey: 'MOD' },
            { id: 'USO_RAPIDO', img: 'uso_rapido', type: 'img', labelKey: 'USO_RAPIDO' },
            { id: 'CHIAVI', img: 'chiavi', type: 'img', labelKey: 'CHIAVI' },
            { id: 'MATERIALI', img: 'crafting', type: 'img', labelKey: 'MATERIALI' },
            { id: 'VARIE', img: 'varie', type: 'img', labelKey: 'VARIE' },
            { id: 'COSMETICS', icon: 'icon-cosmetic', type: 'svg', labelKey: 'COSMETICS' }
        ],
        'PROGETTI': [
            { id: 'ALL', icon: 'icon-all', type: 'svg', labelKey: 'ALL' }, 
            { id: 'ARMI', img: 'armi', type: 'img', labelKey: 'ARMI' },
            { id: 'MOD', img: 'mod', type: 'img', labelKey: 'MOD' },
            { id: 'USO_RAPIDO', img: 'uso_rapido', type: 'img', labelKey: 'USO_RAPIDO' },
            { id: 'MATERIALI', img: 'crafting', type: 'img', labelKey: 'MATERIALI' }
        ],
        'OFFICINA': [
            { id: 'ALL', img: 'tutto', type: 'img', labelKey: 'ALL' },
            { targetId: 'scrappy' },
            { targetId: 'workbench' },
            { targetId: 'weapon_bench' },
            { targetId: 'equipment_bench' },
            { targetId: 'explosives_bench' },
            { targetId: 'refiner' },
            { targetId: 'med_station' },
            { targetId: 'utility_bench' }
        ]
    };

    const dom = {
        grid: document.getElementById('grid-container'),
        loader: document.getElementById('loader'),
        loaderText: document.getElementById('loader-text'),
        search: document.getElementById('searchInput'),
        searchClear: document.getElementById('searchClear'),
        tt: document.getElementById('tooltip'),
        sidebar: document.getElementById('sidebarPanel'),
        sbTooltip: document.getElementById('sidebar-tooltip'),
        imgBtn: document.getElementById('imgModeBtn'),
        wlCounter: document.getElementById('wlCounter'),
        infoModal: document.getElementById('infoModal'),
        adminModal: document.getElementById('adminModal'),
        modalBackdrop: document.getElementById('modalBackdrop'),
        btnWishlistText: document.getElementById('btnWishlistText'),
        btnWishlist: document.getElementById('btnWishlist')
    };

    document.getElementById('folderInput').addEventListener('change', loadDataLocal);
    dom.search.addEventListener('input', (e) => { dom.searchClear.style.display = e.target.value ? 'block' : 'none'; render(); });
    document.getElementById('langSelect').addEventListener('change', (e) => { 
        currentLang = e.target.value; 
        updateStaticText();
        updateUI(); 
        render(); 
        renderSidebar(); 
    });
    
    function updateStaticText() {
        dom.search.placeholder = getUI('search');
        document.querySelectorAll('.nav-item').forEach(el => {
            const key = el.getAttribute('data-nav');
            if(key) el.innerText = getNav(key);
        });
    }

    window.closeInfoModal = function() { 
        dom.infoModal.style.display = 'none'; 
        dom.modalBackdrop.style.display = 'none'; 
        isModalOpen = false; 
    };

    function setSection(sectionName) {
        currentSection = sectionName;
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.toggle('active', el.getAttribute('data-nav') === sectionName);
        });
        
        if(sectionName === 'PROGETTI') {
            document.body.classList.add('section-progetti');
        } else {
            document.body.classList.remove('section-progetti');
        }

        renderSidebar();
        if(document.body.classList.contains('db-loaded')) {
            currentFilter = 'ALL';
            viewMode = 'STASH';
            isWishlistView = false;
            dom.btnWishlist.classList.remove('active');
            updateUI();
            render();
        }
    }

    function renderSidebar() {
        const config = SIDEBAR_CONFIG[currentSection] || [];
        dom.sidebar.innerHTML = "";
        if(config.length === 0) return; 

        // Base URL per le icone (locale o remoto)
        const baseUrl = (imageMode === 'REMOTE') ? GITHUB_RAW_BASE_URL : '';

        config.forEach(item => {
            let realItem = null;
            let displayTitle = "";

            if (currentSection === 'OFFICINA' && item.targetId) {
                realItem = hideoutDB.find(x => x.id === item.targetId);
                displayTitle = realItem ? getLoc(realItem.name) : item.targetId;
            } else {
                displayTitle = getFilter(item.labelKey);
            }

            const div = document.createElement('div');
            div.className = 'filter-circle';
            div.onmouseenter = (e) => showSidebarTooltip(e, displayTitle);
            div.onmouseleave = hideSidebarTooltip;

            let isActive = false;
            if (currentSection === 'OFFICINA') {
                if (item.id === 'ALL' && currentFilter === 'ALL') isActive = true;
                if (item.targetId && currentFilter === item.targetId) isActive = true;
            } else {
                if (item.id === currentFilter) isActive = true;
            }
            if(isActive) div.classList.add('active');

            div.onclick = () => setFilter(item.targetId || item.id);

            if(item.type === 'svg') {
                div.innerHTML = `<svg><use href="#${item.icon}"></use></svg>`;
            } else {
                div.classList.add('has-image');
                let imgName = item.img || item.targetId;
                div.innerHTML = `
                    <img class="icon-inactive" src="${baseUrl}images/menu/${imgName}_inactive.png" onerror="this.style.display='none'" alt="">
                    <img class="icon-active" src="${baseUrl}images/menu/${imgName}_active.png" onerror="this.style.display='none'" alt="">
                `;
            }
            dom.sidebar.appendChild(div);
        });
    }

    function showSidebarTooltip(e, text) {
        if(!text) return;
        const rect = e.currentTarget.getBoundingClientRect();
        dom.sbTooltip.innerText = text;
        dom.sbTooltip.style.display = 'block';
        dom.sbTooltip.style.left = (rect.right + 10) + 'px';
        dom.sbTooltip.style.top = (rect.top + (rect.height / 2) - (dom.sbTooltip.offsetHeight / 2)) + 'px';
    }

    function hideSidebarTooltip() { dom.sbTooltip.style.display = 'none'; }

    function setFilter(f) {
        currentFilter = f; 
        renderSidebar();
        render();
    }

    async function loadDataFromGithub() {
        imageMode = 'REMOTE'; 
        updateImageModeBtn();
        dom.loader.style.display = 'flex';
        
        try {
            dom.loaderText.textContent = "CONNECTING...";
            const repo = 'atarufox/Speranza-Archive';
            const itemsUrl = `https://api.github.com/repos/${repo}/contents/items`;
            const responseItems = await fetch(itemsUrl);
            const filesItems = await responseItems.json();
            const jsonFilesItems = filesItems.filter(f => f.name.endsWith('.json'));
            
            const hideoutUrl = `https://api.github.com/repos/${repo}/contents/hideout`;
            const responseHideout = await fetch(hideoutUrl);
            const filesHideout = await responseHideout.json();
            const jsonFilesHideout = filesHideout.filter(f => f.name.endsWith('.json'));

            const itemPromises = jsonFilesItems.map(file => fetch(file.download_url).then(res => res.json()));
            const hideoutPromises = jsonFilesHideout.map(file => fetch(file.download_url).then(res => res.json()));

            itemsDB = await Promise.all(itemPromises);
            const loadedHideout = await Promise.all(hideoutPromises);
            hideoutDB = normalizeHideoutData(loadedHideout, 'Speranza');

            enableUI();
        } catch (error) {
            console.error(error);
            dom.loader.style.display = 'none';
        }
    }

    async function loadDataLocal(e) {
        const files = Array.from(e.target.files);
        imageMode = 'LOCAL'; 
        updateImageModeBtn();
        dom.loader.style.display = 'flex';
        
        let tempHideoutData = []; 
        const tasks = [];
        for(const f of files) {
            if(f.type.startsWith('image/')) {
                const parts = f.webkitRelativePath.split('/'); parts.shift(); 
                const cleanPath = parts.join('/').toLowerCase(); 
                allImages.set(cleanPath, URL.createObjectURL(f));
            } else if(f.name.endsWith('.json')) {
                tasks.push(readJson(f).then(res => {
                    if (res.type === 'item') itemsDB.push(res.data);
                    if (res.type === 'hideout') tempHideoutData.push(res.data);
                }));
            }
        }
        await Promise.all(tasks);
        hideoutDB = normalizeHideoutData(tempHideoutData, 'Speranza');
        enableUI();
    }

    function normalizeHideoutData(sourceData, sourceRepo) {
        let normalized = [];
        if(Array.isArray(sourceData)) {
            sourceData.forEach(d => {
                if (d.levels) {
                    normalized.push({
                        id: d.id,
                        name: d.name,
                        levels: d.levels.map(l => ({
                            level: l.level,
                            requirements: (l.requirementItemIds || []).map(req => ({
                                item: req.itemId,
                                count: req.quantity
                            }))
                        }))
                    });
                }
            });
        }
        return normalized;
    }

    function getImg(data) {
        if(!data) return null;
        const idLower = data.id.toLowerCase();
        const localPath = `images/items/${idLower}.png`;
        
        if (imageMode === 'REMOTE') {
            if (data.imageFilename) {
                if (data.imageFilename.startsWith('http')) return data.imageFilename;
                return GITHUB_RAW_BASE_URL + data.imageFilename.replace(/^[\/|\\]/, '');
            }
            return allImages.get(localPath) || null;
        } else {
            return allImages.get(localPath) || null;
        }
    }

    function render() {
        const grid = dom.grid; grid.innerHTML = "";
        const search = dom.search.value.toLowerCase();
        const baseUrl = (imageMode === 'REMOTE') ? GITHUB_RAW_BASE_URL : '';

        let source = (currentSection === 'OFFICINA') ? hideoutDB : itemsDB;
        
        // Filtro ricerca e categoria
        let filtered = source.filter(data => {
            if(search && !(getLoc(data.name)||data.id).toLowerCase().includes(search)) return false;
            if(currentFilter !== 'ALL' && currentSection === 'OFFICINA' && data.id !== currentFilter) return false;
            // Altri filtri categoria...
            return true;
        });

        filtered.forEach(data => {
            const rarity = (data.rarity||'common').toLowerCase();
            const slot = document.createElement('div');
            slot.className = `slot ${rarity}`;
            
            let imgUrl = (currentSection === 'OFFICINA') 
                ? `${baseUrl}images/menu/${data.id.toLowerCase()}.png` 
                : getImg(data);

            slot.innerHTML = `<img src="${imgUrl || ''}" onerror="this.style.opacity='0'">`;
            slot.onclick = () => openInfoModal(data);
            grid.appendChild(slot);
        });
    }

    function getLoc(obj) { return obj ? (obj[currentLang] || obj['en'] || "") : ""; }
    function toggleImageMode() { imageMode = (imageMode === 'LOCAL') ? 'REMOTE' : 'LOCAL'; updateImageModeBtn(); render(); renderSidebar(); }
    function updateImageModeBtn() { dom.imgBtn.innerText = `IMG: ${imageMode}`; }
    function enableUI() { document.body.classList.add('db-loaded'); dom.search.disabled = false; dom.loader.style.display = 'none'; setSection('INVENTARIO'); }

    window.pickRepo = function(repo){
        if(repo === 'Local') document.getElementById('folderInput').click();
        else loadDataFromGithub();
    };

</script>
</body>
</html>
<!-- VERSIONING: v1.5.0 | REPO: atarufox/Speranza-Archive | UPDATED: Jan 2025 -->